<!DOCTYPE html>
<html lang="en">

<head>
    <meta charset="UTF-8">
    <meta name="viewport" content="width=device-width, initial-scale=1.0">
    <title>NPK Sensor Communication Flow Simulation</title>
    <style>
        * {
            margin: 0;
            padding: 0;
            box-sizing: border-box;
        }

        body {
            font-family: -apple-system, BlinkMacSystemFont, 'SF Pro Display', 'Segoe UI', 'Helvetica Neue', Arial, sans-serif;
            background: linear-gradient(135deg, #667eea 0%, #764ba2 100%);
            min-height: 100vh;
            padding: 20px;
            color: #1d1d1f;
            overflow-x: hidden;
        }

        .container {
            max-width: 1400px;
            margin: 0 auto;
        }

        .header {
            text-align: center;
            margin-bottom: 30px;
            color: white;
        }

        .header h1 {
            font-size: 2.5rem;
            font-weight: 600;
            letter-spacing: -0.5px;
            margin-bottom: 10px;
            text-shadow: 0 2px 10px rgba(0, 0, 0, 0.2);
        }

        .header p {
            font-size: 1.1rem;
            font-weight: 400;
            opacity: 0.9;
        }

        .controls {
            background: rgba(255, 255, 255, 0.95);
            backdrop-filter: blur(20px) saturate(180%);
            border-radius: 16px;
            padding: 20px;
            margin-bottom: 20px;
            box-shadow: 0 8px 32px rgba(0, 0, 0, 0.1);
            border: 1px solid rgba(255, 255, 255, 0.18);
            display: flex;
            gap: 15px;
            align-items: center;
            justify-content: center;
            flex-wrap: wrap;
        }

        .btn {
            padding: 10px 24px;
            border: none;
            border-radius: 10px;
            font-size: 15px;
            font-weight: 500;
            cursor: pointer;
            transition: all 0.3s ease;
            font-family: inherit;
            box-shadow: 0 2px 8px rgba(0, 0, 0, 0.1);
        }

        .btn-primary {
            background: linear-gradient(135deg, #007AFF 0%, #0051D5 100%);
            color: white;
        }

        .btn-primary:hover {
            transform: translateY(-2px);
            box-shadow: 0 4px 12px rgba(0, 122, 255, 0.4);
        }

        .btn-secondary {
            background: linear-gradient(135deg, #FF9500 0%, #FF6B00 100%);
            color: white;
        }

        .btn-secondary:hover {
            transform: translateY(-2px);
            box-shadow: 0 4px 12px rgba(255, 149, 0, 0.4);
        }

        .btn-danger {
            background: linear-gradient(135deg, #FF3B30 0%, #D70015 100%);
            color: white;
        }

        .btn-danger:hover {
            transform: translateY(-2px);
            box-shadow: 0 4px 12px rgba(255, 59, 48, 0.4);
        }

        .btn-dashboard {
            background: linear-gradient(135deg, #34c759 0%, #30d158 100%);
            color: white;
        }

        .btn-dashboard:hover {
            transform: translateY(-2px);
            box-shadow: 0 4px 12px rgba(52, 199, 89, 0.4);
        }

        .btn:active {
            transform: translateY(0);
        }

        .main-grid {
            display: grid;
            grid-template-columns: 1fr 1fr;
            gap: 20px;
            margin-bottom: 20px;
        }

        .panel {
            background: rgba(255, 255, 255, 0.95);
            backdrop-filter: blur(20px) saturate(180%);
            border-radius: 16px;
            padding: 24px;
            box-shadow: 0 8px 32px rgba(0, 0, 0, 0.1);
            border: 1px solid rgba(255, 255, 255, 0.18);
        }

        .panel-title {
            font-size: 1.3rem;
            font-weight: 600;
            margin-bottom: 20px;
            color: #1d1d1f;
        }

        .flow-canvas {
            background: #f5f5f7;
            border-radius: 12px;
            height: 700px;
            position: relative;
            overflow: hidden;
            box-shadow: inset 0 2px 8px rgba(0, 0, 0, 0.05);
        }

        .component {
            position: absolute;
            background: white;
            border-radius: 12px;
            padding: 12px;
            box-shadow: 0 4px 16px rgba(0, 0, 0, 0.1);
            border: 2px solid #e5e5e7;
            transition: all 0.3s ease;
            display: flex;
            align-items: center;
            gap: 12px;
        }

        .component-icon {
            width: 48px;
            height: 48px;
            object-fit: contain;
            flex-shrink: 0;
        }

        .component-content {
            flex-grow: 1;
            min-width: 0;
        }

        .component:hover {
            transform: translateY(-2px);
            box-shadow: 0 6px 20px rgba(0, 0, 0, 0.15);
        }

        .component-title {
            font-weight: 600;
            font-size: 1rem;
            margin-bottom: 8px;
            color: #1d1d1f;
        }

        .component-status {
            font-size: 0.85rem;
            color: #86868b;
            margin-bottom: 8px;
        }

        .status-indicator {
            width: 8px;
            height: 8px;
            border-radius: 50%;
            display: inline-block;
            margin-right: 6px;
            animation: pulse 2s infinite;
        }

        .status-active {
            background: #34c759;
            box-shadow: 0 0 8px rgba(52, 199, 89, 0.5);
        }

        .status-idle {
            background: #ff9500;
        }

        @keyframes pulse {

            0%,
            100% {
                opacity: 1;
            }

            50% {
                opacity: 0.5;
            }
        }

        .data-packet {
            position: absolute;
            background: linear-gradient(135deg, #007AFF 0%, #5856D6 100%);
            color: white;
            padding: 8px 12px;
            border-radius: 8px;
            font-size: 0.75rem;
            font-weight: 500;
            box-shadow: 0 4px 12px rgba(0, 122, 255, 0.3);
            opacity: 0;
            transition: all 0.5s ease;
            z-index: 100;
        }

        .console {
            background: #1d1d1f;
            color: #f5f5f7;
            border-radius: 12px;
            padding: 16px;
            font-family: 'SF Mono', Monaco, monospace;
            font-size: 0.85rem;
            max-height: 300px;
            overflow-y: auto;
            line-height: 1.6;
        }

        .console-line {
            margin-bottom: 8px;
            animation: fadeIn 0.3s ease;
        }

        @keyframes fadeIn {
            from {
                opacity: 0;
                transform: translateY(5px);
            }

            to {
                opacity: 1;
                transform: translateY(0);
            }
        }

        .console-timestamp {
            color: #86868b;
            margin-right: 8px;
        }

        .console-success {
            color: #34c759;
        }

        .console-info {
            color: #007AFF;
        }

        .console-warning {
            color: #FF9500;
        }

        .stats-grid {
            display: grid;
            grid-template-columns: repeat(3, 1fr);
            gap: 12px;
            margin-top: 16px;
        }

        .stat-card {
            background: #f5f5f7;
            border-radius: 10px;
            padding: 12px;
            text-align: center;
        }

        .stat-label {
            font-size: 0.75rem;
            color: #86868b;
            text-transform: uppercase;
            letter-spacing: 0.5px;
            margin-bottom: 4px;
        }

        .stat-value {
            font-size: 1.5rem;
            font-weight: 600;
            color: #1d1d1f;
        }

        .ndvi-map {
            background: linear-gradient(135deg, #4ade80 0%, #22c55e 50%, #15803d 100%);
            height: 200px;
            border-radius: 10px;
            position: relative;
            overflow: hidden;
            margin-top: 16px;
            box-shadow: inset 0 2px 8px rgba(0, 0, 0, 0.1);
        }

        .npk-overlay {
            position: absolute;
            top: 50%;
            left: 50%;
            transform: translate(-50%, -50%);
            background: rgba(255, 255, 255, 0.9);
            backdrop-filter: blur(10px);
            padding: 12px 20px;
            border-radius: 10px;
            font-weight: 600;
            box-shadow: 0 4px 12px rgba(0, 0, 0, 0.2);
        }

        .health-indicator {
            width: 100%;
            height: 8px;
            background: #e5e5e7;
            border-radius: 4px;
            overflow: hidden;
            margin-top: 12px;
        }

        .health-bar {
            height: 100%;
            border-radius: 4px;
            transition: all 0.5s ease;
        }

        .health-good {
            background: linear-gradient(90deg, #34c759 0%, #30d158 100%);
        }

        .health-moderate {
            background: linear-gradient(90deg, #FF9500 0%, #FFCC00 100%);
        }

        .health-poor {
            background: linear-gradient(90deg, #FF3B30 0%, #FF6B6B 100%);
        }

        .connection-line {
            position: absolute;
            height: 2px;
            background: linear-gradient(90deg, transparent, #007AFF, transparent);
            opacity: 0;
            z-index: 50;
        }

        @keyframes flowLine {
            0% {
                opacity: 0;
            }

            50% {
                opacity: 0.6;
            }

            100% {
                opacity: 0;
            }
        }

        .data-value {
            font-family: 'SF Mono', Monaco, monospace;
            background: #f5f5f7;
            padding: 4px 8px;
            border-radius: 6px;
            font-size: 0.8rem;
            margin-top: 4px;
            display: inline-block;
        }

        /* Scrollbar styling */
        .console::-webkit-scrollbar {
            width: 8px;
        }

        .console::-webkit-scrollbar-track {
            background: #2d2d2f;
            border-radius: 4px;
        }

        .console::-webkit-scrollbar-thumb {
            background: #48484a;
            border-radius: 4px;
        }

        .console::-webkit-scrollbar-thumb:hover {
            background: #5a5a5e;
        }

        @media (max-width: 1024px) {
            .main-grid {
                grid-template-columns: 1fr;
            }
        }
    </style>
</head>

<body>
    <div class="container">
        <div class="header">
            <h1>üå± NPK Sensor IoT Simulation</h1>
            <p>Real-time visualization of ESP32 ‚Üí Flask Server ‚Üí Dashboard data flow</p>
        </div>

        <div class="controls">
            <button class="btn btn-primary" id="startBtn">‚ñ∂ Start Simulation</button>
            <button class="btn btn-secondary" id="pauseBtn">‚è∏ Pause</button>
            <button class="btn btn-danger" id="resetBtn">‚Üª Reset</button>
            <button class="btn btn-dashboard" id="dashboardBtn">üó∫Ô∏è Open Full Dashboard</button>
        </div>

        <div class="main-grid">
            <div class="panel">
                <div class="panel-title">üì° Communication Flow</div>
                <div class="flow-canvas" id="flowCanvas"></div>
            </div>

            <div class="panel">
                <div class="panel-title" style="display: flex; justify-content: space-between; align-items: center;">
                    <span>üìä Dashboard View</span>
                    <button class="btn btn-primary" id="openDashboardBtn" style="padding: 6px 16px; font-size: 13px;">‚Üó
                        Open Full View</button>
                </div>
                <iframe id="dashboardFrame" src="dashboard_with_indices.html"
                    onload="this.contentWindow.document.body.style.zoom='0.60'"
                    style="width: 100%; height: 640px; border: none; border-radius: 10px; box-shadow: inset 0 2px 8px rgba(0,0,0,0.05);"></iframe>
            </div>
        </div>

        <div class="panel">
            <div class="panel-title">üíª System Console</div>
            <div class="console" id="console"></div>
        </div>
    </div>

    <script>
        // Stored NPK data from ESP32
        const nitrogenData = [12, 14, 10, 9, 15];
        const phosphorusData = [7, 8, 6, 5, 9];
        const potassiumData = [11, 10, 12, 9, 13];
        let dataIndex = 0;

        // Simulation state
        let isRunning = false;
        let isPaused = false;
        let simulationInterval = null;
        let packetCount = 0;

        // Component positions and images - Tighter layout to prevent cutoff
        const components = {
            sensor: { x: 10, y: 20, width: 165, height: 90, image: 'assets/npk_sensor.png' },
            esp32: { x: 10, y: 140, width: 165, height: 110, image: 'assets/esp32.png' },
            router: { x: 185, y: 140, width: 155, height: 100, image: 'assets/router.png' },
            server: { x: 350, y: 140, width: 165, height: 110, image: 'assets/server.png' },
            database: { x: 350, y: 20, width: 165, height: 90, image: 'assets/database.png' },
            dashboard: { x: 80, y: 300, width: 360, height: 100, image: '' }
        };

        // Initialize canvas
        function initCanvas() {
            const canvas = document.getElementById('flowCanvas');
            canvas.innerHTML = '';

            // Create ESP32 component
            const esp32 = createComponent('esp32', 'ESP32', 'Idle', components.esp32);
            esp32.querySelector('.component-content').innerHTML += '<div class="data-value" id="esp32Data">N=0 P=0 K=0</div>';
            canvas.appendChild(esp32);

            // Create NPK Sensor
            const sensor = createComponent('sensor', 'NPK Sensor', 'Ready', components.sensor);
            sensor.style.background = 'linear-gradient(135deg, #34c759 0%, #30d158 100%)';
            sensor.style.color = 'white';
            sensor.querySelector('.component-title').style.color = 'white';
            canvas.appendChild(sensor);

            // Create Router
            const router = createComponent('router', 'WiFi Router', 'Connected', components.router);
            canvas.appendChild(router);

            // Create Flask Server
            const server = createComponent('server', 'Flask Server', 'Listening', components.server);
            server.querySelector('.component-content').innerHTML += '<div style="font-size: 0.7rem; margin-top: 4px;">POST /npk-api.php</div>';
            canvas.appendChild(server);

            // Create Database
            const db = createComponent('database', 'CSV Database', 'Ready', components.database);
            db.querySelector('.component-content').innerHTML += '<div style="font-size: 0.7rem; margin-top: 4px;">Records: <span id="dbCount">0</span></div>';
            canvas.appendChild(db);

            // Create Dashboard
            const dashboard = createComponent('dashboard', 'Dashboard', 'Waiting for data', components.dashboard);
            dashboard.querySelector('.component-content').innerHTML += '<div style="font-size: 0.7rem; margin-top: 4px;">GET /npk-data</div>';
            canvas.appendChild(dashboard);
        }

        function createComponent(id, title, status, pos) {
            const comp = document.createElement('div');
            comp.className = 'component';
            comp.id = id;
            comp.style.left = pos.x + 'px';
            comp.style.top = pos.y + 'px';
            comp.style.width = pos.width + 'px';
            comp.style.minHeight = pos.height + 'px';

            const imgHtml = pos.image ? `<img src="${pos.image}" class="component-icon" alt="${title}">` : '';

            comp.innerHTML = `
                ${imgHtml}
                <div class="component-content">
                    <div class="component-title" style="font-size: 0.95rem;">${title}</div>
                    <div class="component-status" style="font-size: 0.85rem;">
                        <span class="status-indicator status-idle"></span>
                        <span id="${id}Status">${status}</span>
                    </div>
                </div>
            `;

            return comp;
        }

        function addConsoleLog(message, type = 'info') {
            const console = document.getElementById('console');
            const timestamp = new Date().toLocaleTimeString();
            const line = document.createElement('div');
            line.className = `console-line console-${type}`;
            line.innerHTML = `<span class="console-timestamp">[${timestamp}]</span>${message}`;
            console.appendChild(line);
            console.scrollTop = console.scrollHeight;
        }

        function updateComponentStatus(id, status, active = false) {
            const statusEl = document.getElementById(`${id}Status`);
            const indicator = document.getElementById(id).querySelector('.status-indicator');

            if (statusEl) statusEl.textContent = status;
            if (indicator) {
                indicator.className = active ? 'status-indicator status-active' : 'status-indicator status-idle';
            }
        }

        function createDataPacket(startX, startY, endX, endY, data, callback) {
            const canvas = document.getElementById('flowCanvas');
            const packet = document.createElement('div');
            packet.className = 'data-packet';
            packet.textContent = data;
            packet.style.left = startX + 'px';
            packet.style.top = startY + 'px';
            canvas.appendChild(packet);

            // Animate packet
            setTimeout(() => {
                packet.style.opacity = '1';
            }, 10);

            setTimeout(() => {
                packet.style.left = endX + 'px';
                packet.style.top = endY + 'px';
            }, 50);

            setTimeout(() => {
                packet.style.opacity = '0';
                setTimeout(() => {
                    canvas.removeChild(packet);
                    if (callback) callback();
                }, 500);
            }, 1500);
        }

        async function runSimulationCycle() {
            if (!isRunning || isPaused) return;

            packetCount++;

            // Step 1: Read from sensor
            let n, p, k;
            if (dataIndex < nitrogenData.length) {
                n = nitrogenData[dataIndex];
                p = phosphorusData[dataIndex];
                k = potassiumData[dataIndex];
                addConsoleLog(`üìñ Reading STORED NPK data [${dataIndex + 1}/${nitrogenData.length}]`, 'info');
                dataIndex++;
            } else {
                n = Math.floor(Math.random() * 12) + 8;
                p = Math.floor(Math.random() * 10) + 5;
                k = Math.floor(Math.random() * 11) + 7;
                addConsoleLog('üé≤ Generating SIMULATED NPK data', 'warning');
            }

            updateComponentStatus('sensor', 'Reading NPK values', true);
            await sleep(500);

            // Step 2: ESP32 receives data via RS485
            updateComponentStatus('esp32', 'Receiving via RS485', true);
            document.getElementById('esp32Data').textContent = `N=${n} P=${p} K=${k}`;
            addConsoleLog(`‚úÖ ESP32 received: N=${n}, P=${p}, K=${k}`, 'success');

            createDataPacket(
                components.sensor.x + components.sensor.width / 2,
                components.sensor.y,
                components.esp32.x + components.esp32.width / 2,
                components.esp32.y + components.esp32.height
            );

            await sleep(800);

            // Step 3: ESP32 sends to router via WiFi
            updateComponentStatus('esp32', 'Sending via WiFi', true);
            updateComponentStatus('router', 'Receiving packet', true);

            const jsonPayload = `{"sensor_id":"ESP32_01","nitrogen":${n},"phosphorus":${p},"potassium":${k}}`;
            addConsoleLog(`üì° WiFi POST ‚Üí ${jsonPayload}`, 'info');

            createDataPacket(
                components.esp32.x + components.esp32.width,
                components.esp32.y + components.esp32.height / 2,
                components.router.x,
                components.router.y + components.router.height / 2,
                'POST'
            );

            await sleep(800);

            // Step 4: Router forwards to server
            updateComponentStatus('router', 'Routing to server', true);
            updateComponentStatus('server', 'Receiving HTTP POST', true);

            createDataPacket(
                components.router.x + components.router.width,
                components.router.y + components.router.height / 2,
                components.server.x,
                components.server.y + components.server.height / 2,
                'JSON'
            );

            await sleep(800);

            // Step 5: Server stores in database
            updateComponentStatus('server', 'Processing data', true);
            updateComponentStatus('database', 'Writing record', true);
            addConsoleLog('üíæ Flask server storing in database...', 'success');

            createDataPacket(
                components.server.x + components.server.width / 2,
                components.server.y + components.server.height,
                components.database.x + components.database.width / 2,
                components.database.y,
                'INSERT'
            );

            await sleep(800);

            const dbCount = document.getElementById('dbCount');
            dbCount.textContent = packetCount;
            updateComponentStatus('database', 'Record saved', false);

            // Step 6: Dashboard requests data
            updateComponentStatus('dashboard', 'Requesting update', true);
            addConsoleLog('üîÑ Dashboard sending GET request...', 'info');

            createDataPacket(
                components.dashboard.x + components.dashboard.width / 2,
                components.dashboard.y,
                components.server.x + components.server.width / 2,
                components.server.y + components.server.height,
                'GET'
            );

            await sleep(800);

            // Step 7: Server responds to dashboard
            updateComponentStatus('server', 'Sending response', true);

            createDataPacket(
                components.server.x + components.server.width / 2,
                components.server.y + components.server.height,
                components.dashboard.x + components.dashboard.width / 2,
                components.dashboard.y,
                'JSON'
            );

            await sleep(800);

            // Step 8: Dashboard updates with data
            updateComponentStatus('dashboard', 'Rendering data', true);

            // Log the NPK values that would be displayed
            addConsoleLog(`üìä Dashboard updated with NPK overlay (N=${n}, P=${p}, K=${k})`, 'success');

            await sleep(1000);

            // Reset status
            updateComponentStatus('esp32', 'Idle', false);
            updateComponentStatus('sensor', 'Ready', false);
            updateComponentStatus('router', 'Connected', false);
            updateComponentStatus('server', 'Listening', false);
            updateComponentStatus('dashboard', 'Displaying data', false);

            addConsoleLog('‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ', 'info');

            // Schedule next cycle
            if (isRunning && !isPaused) {
                setTimeout(runSimulationCycle, 2000);
            }
        }

        function sleep(ms) {
            return new Promise(resolve => setTimeout(resolve, ms));
        }

        // Button handlers
        document.getElementById('startBtn').addEventListener('click', () => {
            if (!isRunning) {
                isRunning = true;
                isPaused = false;
                addConsoleLog('üöÄ Simulation started', 'success');
                runSimulationCycle();
            } else if (isPaused) {
                isPaused = false;
                addConsoleLog('‚ñ∂Ô∏è Simulation resumed', 'success');
                runSimulationCycle();
            }
        });

        document.getElementById('pauseBtn').addEventListener('click', () => {
            if (isRunning && !isPaused) {
                isPaused = true;
                addConsoleLog('‚è∏Ô∏è Simulation paused', 'warning');
            }
        });

        document.getElementById('resetBtn').addEventListener('click', () => {
            isRunning = false;
            isPaused = false;
            dataIndex = 0;
            packetCount = 0;

            document.getElementById('console').innerHTML = '';
            document.getElementById('dbCount').textContent = '0';
            document.getElementById('esp32Data').textContent = 'N=0 P=0 K=0';

            initCanvas();
            addConsoleLog('üîÑ Simulation reset', 'info');
        });

        document.getElementById('dashboardBtn').addEventListener('click', () => {
            addConsoleLog('üó∫Ô∏è Opening full dashboard with indices...', 'info');
            window.open('dashboard_with_indices.html', '_blank');
        });

        document.getElementById('openDashboardBtn').addEventListener('click', () => {
            addConsoleLog('‚Üó Opening dashboard in new window...', 'info');
            window.open('dashboard_with_indices.html', '_blank');
        });

        // Initialize on load
        window.addEventListener('load', () => {
            initCanvas();
            addConsoleLog('‚ú® NPK Sensor IoT Simulation initialized', 'success');
            addConsoleLog('üí° Click "Start Simulation" to begin', 'info');
        });
    </script>
</body>

</html>